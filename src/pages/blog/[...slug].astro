---
import BaseLayout from '../../layouts/BaseLayout.astro';
import BlogCard from '../../components/BlogCard.astro';
import { getCollection, render } from 'astro:content';
import { getLangFromUrl, useTranslations, getLocalizedPath } from '../../i18n/index';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

export async function getStaticPaths() {
  const isDev = import.meta.env.DEV;
  const posts = await getCollection('blog', ({ data }) => isDev || !data.draft);
  return posts.map((post) => ({
    params: { slug: post.id },
    props: post,
  }));
}

const post = Astro.props;
const { Content } = await render(post);

const formattedDate = post.data.pubDate.toLocaleDateString(lang === 'hi' ? 'hi-IN' : 'en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Calculate reading time
const wordCount = post.body?.split(/\s+/g).length || 0;
const readingTime = Math.max(1, Math.round(wordCount / 200));

// Get related posts
const allPosts = await getCollection('blog', ({ data }) => !data.draft && data.title !== post.data.title);
const relatedPosts = allPosts
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 2);
---

<BaseLayout title={`${post.data.title} | Manthan Ankolekar`} description={post.data.description} ogId={post.id}>
  <article class="blog-post">
    <div class="container">
      <header class="post-header">
        <a href={getLocalizedPath('/blog', lang)} class="back-link">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
          {t('blog.backToBlog')}
        </a>
        <h1 class="post-title">{post.data.title}</h1>
        <div class="post-meta">
          <time>{formattedDate}</time>
          <span class="meta-divider">â€¢</span>
          <span class="reading-time">{readingTime} {t('blog.minRead')}</span>
          {post.data.draft && <span class="draft-badge">Draft Preview</span>}
          <div class="post-tags">
            {post.data.tags.map((tag: string) => (
              <span class="post-tag">{tag}</span>
            ))}
          </div>
        </div>
      </header>

      <div class="post-content">
        <Content />
      </div>

      <footer class="post-footer">
        <a href={getLocalizedPath('/blog', lang)} class="btn btn-outline">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
          {t('blog.allPosts')}
        </a>
      </footer>

      {relatedPosts.length > 0 && (
        <section class="related-posts reveal">
          <h2 class="related-title">{t('blog.continueReading')}</h2>
          <div class="related-grid">
            {relatedPosts.map((post) => (
              <BlogCard
                title={post.data.title}
                excerpt={post.data.description}
                date={post.data.pubDate.toLocaleDateString(lang === 'hi' ? 'hi-IN' : 'en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
                tags={post.data.tags}
                url={getLocalizedPath(`/blog/${post.id}`, lang)}
              />
            ))}
          </div>
        </section>
      )}
    </div>
  </article>
</BaseLayout>

<style>
  .blog-post {
    padding-top: 8rem;
    padding-bottom: 5rem;
  }

  .post-header {
    max-width: 720px;
    margin-bottom: 3rem;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.9rem;
    color: var(--color-text-muted);
    margin-bottom: 2rem;
    transition: color var(--transition);
  }

  .back-link:hover {
    color: var(--color-primary);
  }

  .post-title {
    font-size: clamp(1.8rem, 4vw, 2.75rem);
    font-weight: 800;
    line-height: 1.2;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, #fff, var(--color-text));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .post-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .post-meta time {
    font-family: var(--font-mono);
    font-size: 0.85rem;
    color: var(--color-text-muted);
  }

  .meta-divider {
    color: var(--color-border);
    font-size: 0.8rem;
  }

  .draft-badge {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    padding: 0.2rem 0.6rem;
    border-radius: 4px;
    background: #f9e2af;
    color: #1e1e2e;
  }

  .post-tags {
    display: flex;
    gap: 0.4rem;
  }

  .post-tag {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--color-accent-light);
    background: rgba(124, 58, 237, 0.12);
    padding: 0.2rem 0.6rem;
    border-radius: 4px;
  }

  .post-content {
    max-width: 720px;
    line-height: 1.85;
    color: var(--color-text-muted);
    font-size: 1.05rem;
  }

  .post-content :global(h2) {
    font-size: 1.6rem;
    font-weight: 700;
    color: var(--color-text);
    margin-top: 2.5rem;
    margin-bottom: 1rem;
  }

  .post-content :global(h3) {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-text);
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }

  .post-content :global(p) {
    margin-bottom: 1.25rem;
  }

  .post-content :global(a) {
    color: var(--color-primary);
    text-decoration: underline;
    text-underline-offset: 3px;
  }

  .post-content :global(strong) {
    color: var(--color-text);
    font-weight: 600;
  }

  .post-content :global(code) {
    font-family: var(--font-mono);
    font-size: 0.88em;
    background: rgba(0, 212, 255, 0.08);
    color: var(--color-primary);
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
  }

  .post-content :global(pre) {
    background: #1e1e2e !important;
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 1.25rem;
    overflow-x: auto;
    margin: 1.5rem 0;
    line-height: 1.6;
  }

  .post-content :global(pre code) {
    background: none;
    padding: 0;
    color: var(--color-text);
    font-size: 0.85rem;
  }

  .post-content :global(ul),
  .post-content :global(ol) {
    margin-bottom: 1.25rem;
    padding-left: 1.5rem;
  }

  .post-content :global(li) {
    margin-bottom: 0.5rem;
  }

  .post-content :global(ul li)::marker {
    color: var(--color-primary);
  }

  .post-content :global(ol li)::marker {
    color: var(--color-primary);
    font-weight: 600;
  }

  .post-content :global(blockquote) {
    border-left: 3px solid var(--color-primary);
    padding-left: 1.25rem;
    margin: 1.5rem 0;
    color: var(--color-text-muted);
    font-style: italic;
  }

  .post-content :global(hr) {
    border: none;
    border-top: 1px solid var(--color-border);
    margin: 2rem 0;
  }

  .post-footer {
    max-width: 720px;
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border);
  }

  .related-posts {
    margin-top: 5rem;
    padding-top: 3rem;
    border-top: 1px solid var(--color-border);
  }

  .related-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 2rem;
    background: linear-gradient(135deg, var(--color-gradient-start), var(--color-gradient-end));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .related-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(min(300px, 100%), 1fr));
    gap: 1.5rem;
  }

  @media (max-width: 768px) {
    .blog-post {
      padding-top: 6rem;
    }

    .post-content :global(h2) {
      font-size: 1.35rem;
    }

    .post-content :global(h3) {
      font-size: 1.1rem;
    }

    .post-content {
      font-size: 0.95rem;
    }

    .post-content :global(pre) {
      padding: 0.85rem;
      margin-left: -1rem;
      margin-right: -1rem;
      border-radius: 0;
    }

    .post-content :global(pre code) {
      font-size: 0.78rem;
    }
  }
</style>
