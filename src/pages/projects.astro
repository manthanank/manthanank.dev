---
import BaseLayout from '../layouts/BaseLayout.astro';
import ProjectCard from '../components/ProjectCard.astro';
import { getCollection } from 'astro:content';

const localProjects = await getCollection('projects');
const projectSlugsMap = new Map(localProjects.map(p => [p.id, p.id]));
// Also map by title (simplified) for GitHub matching
const projectTitlesMap = new Map(localProjects.map(p => [p.data.title.toLowerCase(), p.id]));

const GITHUB_TOKEN = import.meta.env.GITHUB_TOKEN;
const GITHUB_USERNAME = 'manthanank';

const query = `
  query ($username: String!) {
    user(login: $username) {
      pinnedItems(first: 6, types: REPOSITORY) {
        nodes {
          ... on Repository {
            name
            description
            url
            homepageUrl
            stargazerCount
            languages(first: 3, orderBy: {field: SIZE, direction: DESC}) {
              nodes {
                name
              }
            }
          }
        }
      }
      repositories(first: 20, orderBy: {field: UPDATED_AT, direction: DESC}, ownerAffiliations: OWNER, isFork: false) {
        nodes {
          name
          description
          url
          homepageUrl
          stargazerCount
          languages(first: 3, orderBy: {field: SIZE, direction: DESC}) {
            nodes {
              name
            }
          }
          isArchived
        }
      }
    }
  }
`;

let pinnedProjects: any[] = [];
let otherProjects: any[] = [];

try {
  const res = await fetch('https://api.github.com/graphql', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${GITHUB_TOKEN}`,
    },
    body: JSON.stringify({
      query,
      variables: { username: GITHUB_USERNAME },
    }),
  });

  if (res.ok) {
    const { data } = await res.json();
    const user = data?.user;

    pinnedProjects = user?.pinnedItems?.nodes.map((repo: any) => {
      const title = repo.name.replace(/-/g, ' ').replace(/\b\w/g, (c: string) => c.toUpperCase());
      const slug = projectSlugsMap.get(repo.name.toLowerCase()) || projectTitlesMap.get(title.toLowerCase());
      return {
        title,
        description: repo.description,
        tags: repo.languages?.nodes.map((l: any) => l.name) || [],
        github: repo.url,
        live: repo.homepageUrl || undefined,
        stars: repo.stargazerCount,
        slug
      };
    }) || [];

    const pinnedNames = user?.pinnedItems?.nodes.map((repo: any) => repo.name) || [];

    otherProjects = user?.repositories?.nodes
      .filter((repo: any) => !repo.isArchived && !pinnedNames.includes(repo.name))
      .slice(0, 12)
      .map((repo: any) => {
        const title = repo.name.replace(/-/g, ' ').replace(/\b\w/g, (c: string) => c.toUpperCase());
        const slug = projectSlugsMap.get(repo.name.toLowerCase()) || projectTitlesMap.get(title.toLowerCase());
        return {
          title,
          description: repo.description || 'A project built with modern web technologies.',
          tags: repo.languages?.nodes.map((l: any) => l.name) || [],
          github: repo.url,
          live: repo.homepageUrl || undefined,
          stars: repo.stargazerCount,
          slug
        };
      }) || [];
  } else {
    throw new Error('GraphQL request failed');
  }
} catch (e) {
  console.warn('Failed to fetch via GraphQL, using fallback data. Make sure GITHUB_TOKEN is set.');
  
  pinnedProjects = [
    {
      title: 'Learn Angular',
      description: 'A comprehensive learning resource for Angular developers with examples, best practices, and hands-on projects.',
      tags: ['Angular', 'TypeScript', 'RxJS'],
      github: 'https://github.com/manthanank/learn-angular',
      live: 'https://learn-angular.netlify.app',
      slug: 'learn-angular'
    },
    {
      title: 'Learn Node.js',
      description: 'A curated learning resource for Node.js fundamentals, backend patterns, and real-world examples.',
      tags: ['Node.js', 'JavaScript', 'Backend'],
      github: 'https://github.com/manthanank/learn-nodejs',
    },
  ];

  otherProjects = [
    {
      title: 'manthanank.dev',
      description: 'My portfolio site built with Astro for fast performance, SEO, and a modern UI.',
      tags: ['Astro', 'TypeScript', 'CSS'],
      github: 'https://github.com/manthanank/manthanank.dev',
      live: 'https://manthanank.dev',
    },
    {
      title: 'E-Commerce App',
      description: 'A full-featured e-commerce application with product listings, cart, checkout, and payment integration.',
      tags: ['Angular', 'Node.js', 'Stripe', 'MongoDB'],
      github: 'https://github.com/manthanank/ecommerce-app',
    },
  ];
}
---

<BaseLayout title="Projects | Manthan Ankolekar" description="A showcase of my recent work and open source contributions.">
  <section class="section projects-hero">
    <div class="container">
      <h1 class="section-title">Projects</h1>
      <p class="section-subtitle">A showcase of my recent work and open source contributions.</p>
    </div>
  </section>

  <!-- Pinned Projects -->
  <section class="container pinned-section">
    <h2 class="subsection-title">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17v5"/><path d="M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z"/></svg>
      Pinned Projects
    </h2>
    <div class="projects-grid pinned-grid">
      {pinnedProjects.map((project) => (
        <ProjectCard {...project} />
      ))}
    </div>
  </section>

  <!-- All Projects -->
  <section class="container projects-section">
    <h2 class="subsection-title">
      {otherProjects.length > 0 ? 'Latest Repositories' : 'More Projects'}
    </h2>
    <div class="projects-grid">
      {otherProjects.map((project) => (
        <ProjectCard {...project} />
      ))}
    </div>

    <div class="github-cta">
      <p>Want to see more of my code and contributions?</p>
      <a href="https://github.com/manthanank" target="_blank" rel="noopener noreferrer" class="btn btn-outline">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></svg>
        View My GitHub
      </a>
    </div>
  </section>
</BaseLayout>

<style>
  .projects-hero {
    padding-top: 8rem;
    padding-bottom: 0;
  }

  .pinned-section {
    padding-bottom: 2rem;
  }

  .projects-section {
    padding-bottom: 5rem;
  }

  .subsection-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1.15rem;
    font-weight: 600;
    color: var(--color-text-muted);
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--color-border);
  }

  .subsection-title svg {
    color: var(--color-primary);
  }

  .projects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(min(320px, 100%), 1fr));
    gap: 1.5rem;
  }

  .pinned-grid {
    grid-template-columns: repeat(auto-fill, minmax(min(400px, 100%), 1fr));
  }

  .github-cta {
    text-align: center;
    margin-top: 4rem;
    padding: 3rem;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
  }

  .github-cta p {
    color: var(--color-text-muted);
    margin-bottom: 1.5rem;
    font-size: 1.05rem;
  }

  @media (max-width: 768px) {
    .projects-hero {
      padding-top: 6rem;
    }

    .projects-grid,
    .pinned-grid {
      grid-template-columns: 1fr;
    }

    .github-cta {
      padding: 2rem 1.5rem;
    }
  }
</style>
