---
import BaseLayout from '../layouts/BaseLayout.astro';
import { Image } from 'astro:assets';
import SkillBadge from '../components/SkillBadge.astro';
import ExperienceItem from '../components/ExperienceItem.astro';
import { getLangFromUrl, useTranslations, getLocalizedPath } from '../i18n/index';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const frontendSkills = ['Angular', 'React', 'TypeScript', 'JavaScript', 'HTML5', 'CSS3', 'SCSS', 'RxJS', 'NgRx', 'Astro'];
const backendSkills = ['Node.js', 'Express.js', 'MongoDB', 'REST APIs', 'PostgreSQL', 'Firebase'];
const toolsSkills = ['Git', 'GitHub', 'VS Code', 'Docker', 'npm', 'Webpack', 'Netlify', 'Firebase'];

const GITHUB_TOKEN = import.meta.env.GITHUB_TOKEN;

// Build-time validation
if (!GITHUB_TOKEN && import.meta.env.PROD) {
  console.error('âŒ GITHUB_TOKEN is missing! GitHub statistics will not be rendered in production.');
}
const GITHUB_USERNAME = 'manthanank';

const statsQuery = `
  query ($username: String!) {
    user(login: $username) {
      repositories(first: 100, ownerAffiliations: OWNER, isFork: false, orderBy: {field: PUSHED_AT, direction: DESC}) {
        totalCount
        nodes {
          name
          url
          stargazerCount
          pushedAt
          languages(first: 10, orderBy: {field: SIZE, direction: DESC}) {
            nodes {
              name
            }
          }
          defaultBranchRef {
            target {
              ... on Commit {
                message
                committedDate
              }
            }
          }
        }
      }
      contributionsCollection {
        totalCommitContributions
        restrictedContributionsCount
      }
    }
  }
`;

let githubStats = {
  repos: 0,
  stars: 0,
  commits: 0,
  topLanguages: [] as string[],
  latestActivity: null as any
};

try {
  const res = await fetch('https://api.github.com/graphql', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${GITHUB_TOKEN}`,
    },
    body: JSON.stringify({
      query: statsQuery,
      variables: { username: GITHUB_USERNAME },
    }),
  });

  if (res.ok) {
    const { data } = await res.json();
    const user = data?.user;
    
    githubStats.repos = user?.repositories?.totalCount || 0;
    githubStats.stars = user?.repositories?.nodes?.reduce((acc: number, repo: any) => acc + repo.stargazerCount, 0) || 0;
    githubStats.commits = (user?.contributionsCollection?.totalCommitContributions || 0) + (user?.contributionsCollection?.restrictedContributionsCount || 0);
    
    // Calculate top languages
    const langCounts: Record<string, number> = {};
    user?.repositories?.nodes?.forEach((repo: any) => {
      repo.languages?.nodes?.forEach((lang: any) => {
        langCounts[lang.name] = (langCounts[lang.name] || 0) + 1;
      });
    });
    githubStats.topLanguages = Object.entries(langCounts)
      .sort(([, a], [, b]) => b - a)
      .slice(0, 5)
      .map(([name]) => name);

    // Latest Activity
    const latestRepo = user?.repositories?.nodes?.[0];
    if (latestRepo) {
      const commit = latestRepo.defaultBranchRef?.target;
      githubStats.latestActivity = {
        repoName: latestRepo.name,
        repoUrl: latestRepo.url,
        message: commit?.message?.split('\n')[0],
        date: commit?.committedDate ? new Date(commit.committedDate).toLocaleDateString() : null,
        relativeDate: commit?.committedDate ? (() => {
          const diff = Date.now() - new Date(commit.committedDate).getTime();
          const days = Math.floor(diff / (1000 * 60 * 60 * 24));
          if (days === 0) return t('date.today');
          if (days === 1) return t('date.yesterday');
          return `${days} ${t('date.daysAgo')}`;
        })() : null
      };
    }
  }
} catch (e) {
  console.warn('Failed to fetch GitHub stats');
}

const experience = [
  {
    title: t('exp.title1'),
    company: t('exp.company1'),
    period: '2022 - Present',
    description: [
      t('exp.desc1_1'),
      t('exp.desc1_2'),
      t('exp.desc1_3'),
      t('exp.desc1_4'),
    ],
  },
  {
    title: t('exp.title2'),
    company: t('exp.company2'),
    period: '2020 - 2022',
    description: [
      t('exp.desc2_1'),
      t('exp.desc2_2'),
      t('exp.desc2_3'),
      t('exp.desc2_4'),
    ],
  },
];

const {
  repos = 0,
  stars = 0,
  commits = 0,
  topLanguages = [],
  latestActivity = null
} = githubStats;
---

<BaseLayout title={`${t('about.title')} | Manthan Ankolekar`} description={t('about.subtitle')}>
  <section class="section about-hero">
    <div class="container">
      <h1 class="section-title">{t('about.title')}</h1>
      <p class="section-subtitle">{t('about.subtitle')}</p>
    </div>
  </section>

  <section class="container about-content">
    <div class="about-grid">
      <div class="about-text">
        <h2>{t('about.hello')}</h2>
        <p set:html={t('about.bio1')}></p>
        <p set:html={t('about.bio2')}></p>
        <p set:html={t('about.bio3')}></p>
        <div class="about-actions">
          <a href="/resume.pdf" download class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
            {t('about.downloadResume')}
          </a>
          <a href={getLocalizedPath('/contact', lang)} class="btn btn-outline btn-magnetic">{t('contact.letsConnect')}</a>
        </div>
        <div class="about-stats">
          <div class="stat">
            <span class:list={["stat-number", { skeleton: !repos }]}>{repos || '80+'}</span>
            <span class="stat-label">{t('about.repositories')}</span>
          </div>
          <div class="stat">
            <span class:list={["stat-number", { skeleton: !stars }]}>{stars || '45'}</span>
            <span class="stat-label">{t('about.totalStars')}</span>
          </div>
          <div class="stat">
            <span class:list={["stat-number", { skeleton: !commits }]}>{commits || '500+'}</span>
            <span class="stat-label">{t('about.contributions')}</span>
          </div>
          <div class="stat">
            <span class="stat-number">10+</span>
            <span class="stat-label">{t('about.npmPackages')}</span>
          </div>
        </div>
        {githubStats.topLanguages.length > 0 && (
          <div class="top-stack">
            <span class="stack-label">{t('about.topStack')}</span>
            <div class="stack-list">
              {githubStats.topLanguages.map(lang => (
                <span class="stack-item">{lang}</span>
              ))}
            </div>
          </div>
        )}
        {githubStats.latestActivity && (
          <div class="live-activity reveal reveal-delay-2">
            <div class="activity-header">
              <span class="pulse-icon"></span>
              <span class="activity-label">{t('about.liveActivity')}</span>
            </div>
            <div class="activity-card">
              <div class="activity-repo">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></svg>
                <a href={githubStats.latestActivity.repoUrl} target="_blank" rel="noopener noreferrer">{githubStats.latestActivity.repoName}</a>
              </div>
              <p class="activity-message">"{githubStats.latestActivity.message}"</p>
              <span class="activity-date">{githubStats.latestActivity.relativeDate}</span>
            </div>
          </div>
        )}
      </div>
      <div class="about-image">
        <div class="image-frame">
          <Image 
            src="/profile.jpg" 
            alt="Manthan Ankolekar" 
            width={350} 
            height={350} 
            format="avif" 
            quality="mid"
            loading="eager"
            class="profile-img" 
          />
          <div class="profile-avatar-overlay">
            <p class="avatar-name">{t('hero.name')}</p>
            <p class="avatar-role">{t('hero.role')}</p>
            <div class="avatar-links">
              <a href="https://github.com/manthanank" target="_blank" rel="noopener noreferrer" aria-label="GitHub">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></svg>
              </a>
              <a href="https://linkedin.com/in/manthanank" target="_blank" rel="noopener noreferrer" aria-label="LinkedIn">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/><rect width="4" height="12" x="2" y="9"/><circle cx="4" cy="4" r="2"/></svg>
              </a>
              <a href="https://x.com/manthan_ank" target="_blank" rel="noopener noreferrer" aria-label="X">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Skills -->
  <section class="section skills-detail">
    <div class="container">
      <h2 class="section-title">{t('about.skillsTitle')}</h2>
      <p class="section-subtitle">{t('about.skillsSubtitle')}</p>
 
      <div class="skills-categories">
        <div class="skill-category">
          <h3 class="category-title">{t('about.frontend')}</h3>
          <div class="skill-list">
            {frontendSkills.map((skill) => <SkillBadge name={skill} />)}
          </div>
        </div>
        <div class="skill-category">
          <h3 class="category-title">{t('about.backend')}</h3>
          <div class="skill-list">
            {backendSkills.map((skill) => <SkillBadge name={skill} />)}
          </div>
        </div>
        <div class="skill-category">
          <h3 class="category-title">{t('about.tools')}</h3>
          <div class="skill-list">
            {toolsSkills.map((skill) => <SkillBadge name={skill} />)}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Experience -->
  <section class="section">
    <div class="container">
      <h2 class="section-title">{t('about.experienceTitle')}</h2>
      <p class="section-subtitle">{t('about.experienceSubtitle')}</p>
      <div class="experience-timeline">
        <div class="timeline-track">
          <div class="timeline-progress"></div>
        </div>
        {experience.map((exp) => <ExperienceItem {...exp} />)}
      </div>
    </div>
  </section>

  <script>
    function initTimeline() {
      const timeline = document.querySelector('.experience-timeline');
      const progress = document.querySelector('.timeline-progress') as HTMLElement;
      const items = document.querySelectorAll('.experience-item');

      if (!timeline || !progress) return;

      const observerOptions = {
        root: null,
        threshold: 0.5,
      };

      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add('active');
          }
        });
      }, observerOptions);

      items.forEach((item) => observer.observe(item));

      window.addEventListener('scroll', () => {
        const rect = timeline.getBoundingClientRect();
        const windowHeight = window.innerHeight;
        
        // Calculate progress based on timeline position in viewport
        if (rect.top < windowHeight && rect.bottom > 0) {
          const totalHeight = rect.height;
          const visiblePart = windowHeight - rect.top;
          const percentage = Math.min(100, Math.max(0, (visiblePart / (totalHeight + 100)) * 100));
          progress.style.height = `${percentage}%`;
        }
      });
    }

    // Run on load
    initTimeline();

    // Run after view transitions
    document.addEventListener('astro:after-swap', initTimeline);
  </script>
</BaseLayout>

<style>
  .about-hero {
    padding-top: 8rem;
    padding-bottom: 2rem;
  }

  .about-grid {
    display: grid;
    grid-template-columns: 1.2fr 0.8fr;
    gap: 4rem;
    align-items: start;
    padding-bottom: 3rem;
  }

  .about-text h2 {
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 1.25rem;
    color: var(--color-text);
  }

  .about-text p {
    color: var(--color-text-muted);
    font-size: 1rem;
    line-height: 1.8;
    margin-bottom: 1rem;
  }

  .about-text strong {
    color: var(--color-primary);
  }

  .about-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
    flex-wrap: wrap;
  }

  .about-stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border);
  }

  .stat {
    text-align: center;
  }

  .stat-number {
    display: block;
    font-size: 1.75rem;
    font-weight: 800;
    background: linear-gradient(135deg, var(--color-gradient-start), var(--color-gradient-end));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .stat-label {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    margin-top: 0.25rem;
  }

  .top-stack {
    margin-top: 2rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .stack-label {
    font-size: 0.85rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--color-text-muted);
  }

  .stack-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .stack-item {
    font-size: 0.8rem;
    padding: 0.25rem 0.75rem;
    border-radius: 6px;
    background: rgba(0, 212, 255, 0.05);
    color: var(--color-primary);
    border: 1px solid rgba(0, 212, 255, 0.1);
    font-family: var(--font-mono);
  }

  .live-activity {
    margin-top: 2.5rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border);
  }

  .activity-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .activity-label {
    font-size: 0.85rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--color-text-muted);
  }

  .pulse-icon {
    width: 8px;
    height: 8px;
    background: #a6e3a1;
    border-radius: 50%;
    box-shadow: 0 0 0 rgba(166, 227, 161, 0.4);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% {
      transform: scale(0.95);
      box-shadow: 0 0 0 0 rgba(166, 227, 161, 0.7);
    }
    70% {
      transform: scale(1);
      box-shadow: 0 0 0 10px rgba(166, 227, 161, 0);
    }
    100% {
      transform: scale(0.95);
      box-shadow: 0 0 0 0 rgba(166, 227, 161, 0);
    }
  }

  .activity-card {
    background: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    padding: 1.25rem;
  }

  .activity-repo {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .activity-repo a {
    color: var(--color-primary);
  }

  .activity-message {
    font-size: 0.9rem;
    color: var(--color-text);
    font-style: italic;
    margin-bottom: 0.75rem;
    line-height: 1.5;
  }

  .activity-date {
    display: block;
    font-size: 0.75rem;
    color: var(--color-text-muted);
    font-family: var(--font-mono);
  }

  .image-frame {
    position: relative;
    border-radius: var(--radius);
    overflow: hidden;
    border: 1px solid var(--color-border);
    max-width: 350px;
    margin-left: auto;
    background: var(--color-bg-card);
  }

  .profile-img {
    width: 100%;
    height: auto;
    display: block;
    aspect-ratio: 1/1;
    object-fit: cover;
    filter: brightness(0.8);
    transition: filter var(--transition);
  }

  .image-frame:hover .profile-img {
    filter: brightness(1);
  }

  .profile-avatar-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 1.5rem;
    background: linear-gradient(to top, rgba(15, 15, 15, 0.9) 0%, rgba(15, 15, 15, 0) 100%);
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }

  .avatar-name {
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--color-text);
    margin-bottom: 0.25rem;
  }

  .avatar-role {
    font-size: 0.85rem;
    color: var(--color-text-muted);
    font-family: var(--font-mono);
    margin-bottom: 0.75rem;
  }

  .avatar-links {
    display: flex;
    gap: 0.75rem;
  }

  .avatar-links a {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(4px);
    color: var(--color-text);
    transition: all var(--transition);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .avatar-links a:hover {
    color: var(--color-primary);
    background: rgba(0, 212, 255, 0.1);
    border-color: var(--color-primary);
    transform: translateY(-2px);
  }

  /* Skills Detail */
  .skills-detail {
    background: var(--color-bg-alt);
    border-top: 1px solid var(--color-border);
    border-bottom: 1px solid var(--color-border);
  }

  .skills-categories {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 2rem;
  }

  .skill-category {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 1.75rem;
  }

  .category-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-primary);
    margin-bottom: 1rem;
    font-family: var(--font-mono);
  }

  .skill-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .experience-timeline {
    max-width: 800px;
    position: relative;
    padding-left: 0.5rem;
  }

  .timeline-track {
    position: absolute;
    left: 8px; /* Sync with experience-item padding and dot size */
    top: 5px;
    bottom: 5px;
    width: 2px;
    background: var(--color-border);
  }

  .timeline-progress {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 0;
    background: linear-gradient(to bottom, var(--color-primary), var(--color-accent));
    box-shadow: 0 0 10px var(--color-primary);
    transition: height 0.1s linear;
  }

  @media (max-width: 768px) {
    .about-hero {
      padding-top: 6rem;
    }

    .about-grid {
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    .about-image {
      order: -1;
    }

    .image-frame {
      max-width: 250px;
      margin: 0 auto;
    }

    .about-actions {
      justify-content: center;
    }

    .about-stats {
      grid-template-columns: repeat(2, 1fr);
    }

    .skills-categories {
      grid-template-columns: 1fr;
    }

    .experience-header {
      flex-direction: column;
      align-items: flex-start;
    }
  }

  @media (max-width: 480px) {
    .about-stats {
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }

    .stat-number {
      font-size: 1.4rem;
    }

    .about-actions {
      flex-direction: column;
      align-items: stretch;
    }

    .about-actions .btn {
      justify-content: center;
    }
  }
</style>
